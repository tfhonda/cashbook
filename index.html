<!DOCTYPE html>
<html lang="ja">
<!-- rebuild -->
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>現金出納帳</title>

  <script src="config.js?v=7"></script>

  <style>
    body {
      font-size: 22px;
      padding: 20px;
      max-width: 480px;
      margin: auto;
      line-height: 1.6;
    }

    label {
      display: block;
      margin-top: 20px;
    }

    input, select, button {
      width: 100%;
      font-size: 22px;
      padding: 12px;
      margin-top: 8px;
      box-sizing: border-box;
    }

    button {
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      margin-top: 30px;
    }
  </style>
</head>

<body>

  <h2>現金出納帳 入力フォーム</h2>

  <label>日付</label>
  <input type="date" id="date">

  <label>区分</label>
  <select id="type" onchange="loadSubjects()">
    <option value="">選択してください</option>
    <option value="収入">収入</option>
    <option value="支出">支出</option>
  </select>

  <label>科目</label>
  <select id="subject" onchange="loadTekiyo()" disabled>
  <option value="">区分を先に選択</option>
</select>

  <label>摘要</label>
  <select id="tekiyoSelect" style="display:none;"></select>
  <input type="text" id="tekiyoInput" style="display:none;" placeholder="摘要を入力">

  <label>金額</label>
  <input type="text" id="amount" oninput="formatAmountField()">

  <button onclick="submitForm()">登録</button>

  <p id="result"></p>

  <button type="button" onclick="location.href='list.html'">一覧を見る</button>

  <script>
    let masterData = null;
   function formatAmount(el) {
    let v = el.value.replace(/,/g, "");   // カンマ除去
    if (v === "" || isNaN(v)) return;     // 数字以外は無視
    el.value = Number(v).toLocaleString(); // 3桁区切り
}
    // ★ GAS の doGet() からマスターデータを取得
    window.onload = function() {
      fetch(GAS_URL + "?action=getMasterForIndex")
        .then(res => res.json())
        .then(data => {
          console.log("masterData:", data);  // ← 追加（確認用）
          masterData = data;

           // ★ 科目選択を有効化
          document.getElementById("subject").disabled = false;
        });
    };

    // ★ 区分 → 科目
    function loadSubjects() {
      const kubun = document.getElementById("type").value;
      const subject = document.getElementById("subject");

      subject.innerHTML = "<option value=''>選択してください</option>";

      if (masterData && masterData.subjects[kubun]) {
        masterData.subjects[kubun].forEach(k => {
          subject.innerHTML += `<option value="${k}">${k}</option>`;
        });
      }

      document.getElementById("tekiyoSelect").style.display = "none";
      document.getElementById("tekiyoInput").style.display = "none";
    }

function loadTekiyo() {
  const kamoku = document.getElementById("subject").value;

  // ★ 科目が未選択なら何もしない（エラー防止）
  if (!kamoku) {
    return;
  }

  // ★ デバッグ用ログ（ここは return の外に置く）
  console.log("選択された科目:", kamoku);
  console.log("masterData.tekiyo のキー一覧:", Object.keys(masterData.tekiyo));
  console.log("一致するデータ:", masterData.tekiyo[kamoku]);

  const tekiyoData = masterData.tekiyo[kamoku];

  const select = document.getElementById("tekiyoSelect");
  const input = document.getElementById("tekiyoInput");

  select.style.display = "none";
  input.style.display = "none";

  if (!tekiyoData) return;

  const type = tekiyoData.type;
  const options = tekiyoData.options;

  // ① 月選択（1〜12月）
  if (type === "monthSelect") {
    select.innerHTML = "<option value=''>選択してください</option>";
    options.forEach(o => {
      select.innerHTML += `<option value="${o}">${o}</option>`;
    });
    select.style.display = "block";
  }

 
  // ② 選択肢＋手入力（selectOrManual）
  else if (type === "select" || type === "selectOrManual") {
    select.innerHTML = "<option value=''>選択してください</option>";
    options.forEach(o => {
      select.innerHTML += `<option value="${o}">${o}</option>`;
    });
    select.innerHTML += `<option value="__manual__">（手入力）</option>`;
    select.style.display = "block";

    select.onchange = function() {
      if (select.value === "__manual__") {
        select.style.display = "none";
        input.style.display = "block";
        input.value = "";
      }
    };
  }

  // ③ 手入力のみ（初期値あり）
  else if (type === "manualOnly") {
    input.style.display = "block";
    input.value = options[0];
  }

  // ④ 空欄（白紙）
  else if (type === "blank") {
    input.style.display = "block";
    input.value = "";
  }
}

// 金額入力：フォーカスが当たったらカンマを外す
function unformatAmount() {
  const amountInput = document.getElementById("amount");
  const value = amountInput.value.replace(/,/g, "");
  amountInput.value = value;
}

// 金額入力：フォーカスが外れたら3桁区切りにする
function formatAmountField() {
  const amountInput = document.getElementById("amount");
  let value = amountInput.value.replace(/,/g, "");

  if (value === "") return;

  const number = Number(value);
  if (!isNaN(number)) {
    amountInput.value = number.toLocaleString("ja-JP");
  }
}

// ★ GAS の doPost() に送信
function submitForm() {
  const data = {
    date: document.getElementById("date").value,
    type: document.getElementById("type").value,
    subject: document.getElementById("subject").value,
    tekiyo:
      document.getElementById("tekiyoSelect").style.display !== "none"
        ? document.getElementById("tekiyoSelect").value
        : document.getElementById("tekiyoInput").value,
    amount: document.getElementById("amount").value.replace(/,/g, "")
  };

  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  })
  .then(res => res.text())
  .then(text => {
    console.log("GAS response:", text);
    document.getElementById("result").innerText = "登録しました！";
    clearForm();
  })
  .catch(err => console.error("送信エラー:", err));
}

    function clearForm() {
      document.getElementById("date").value = "";
      document.getElementById("type").value = "";
      document.getElementById("subject").innerHTML = "<option value=''>区分を先に選択     </option>";
      document.getElementById("tekiyoSelect").style.display = "none";
      document.getElementById("tekiyoInput").style.display = "none";
      document.getElementById("tekiyoInput").value = "";
      document.getElementById("amount").value = "";
    }
  </script>

</body>

</html>
